<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Harbour Control ‚Äî Levels + Storm Handling</title>
<style>
  body{
    margin:0;
    font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:#0b1220;
    color:#e7eefc;
    display:flex;
    justify-content:center;
    padding:26px;
  }
  .app{width:min(1100px,100%);}
  h1{margin:0 0 8px}
  p{margin:0 0 14px;color:#a9b7d3;line-height:1.35}
  .wrap{
    display:grid;
    grid-template-columns: 1fr 320px;
    gap:12px;
  }
  .stage{
    background:#081124;
    padding:12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
  }
  canvas{
    width:100%;
    height:auto;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.10);
    background:#0e1b33;
    display:block;
    touch-action:none; /* belangrijk: voorkom scroll/zoom op canvas */
  }
  .panel{
    background:#081124;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    padding:12px;
    display:grid;
    gap:10px;
  }
  .card{
    background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.08);
    border-radius:14px;
    padding:10px;
  }
  .row{display:flex; justify-content:space-between; gap:10px; color:#a9b7d3; font-size:13px}
  .row strong{color:#e7eefc}
  .msg{
    padding:10px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.18);
    color:#a9b7d3;
    min-height:62px;
    line-height:1.35;
  }
  .controls{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  button{
    padding:10px 12px;
    border-radius:12px;
    border:none;
    font-weight:900;
    cursor:pointer;
  }
  .primary{background:#60a5fa;color:#081124}
  .secondary{background:#1e293b;color:#e7eefc}
  .danger{background:#7f1d1d;color:#e7eefc}
  .ghost{background:rgba(255,255,255,.08); color:#e7eefc; border:1px solid rgba(255,255,255,.12)}

  /* ---------- Mobiele touch controls ---------- */
  .touchControls{ display:none; }
  .touchControls .dpad{
    display:grid;
    grid-template-columns:64px 64px 64px;
    grid-template-rows:64px 64px 64px;
    gap:10px;
    justify-content:center;
  }
  .touchControls .dpad button{
    width:64px;
    height:64px;
    border-radius:16px;
    font-size:22px;
    font-weight:900;
    touch-action: manipulation;
  }
  .touchControls .up{grid-column:2;grid-row:1}
  .touchControls .left{grid-column:1;grid-row:2}
  .touchControls .right{grid-column:3;grid-row:2}
  .touchControls .down{grid-column:2;grid-row:3}

  @media (max-width: 980px){
    .wrap{grid-template-columns:1fr}
    .touchControls{ display:block; }
  }
</style>
</head>
<body>
<div class="app">
  <h1>Harbour Control</h1>
  <p>
    Vaar je schip veilig naar de haven. Je moet <strong>door alle boeien-poorten</strong> (in volgorde),
    <strong>ondiepte</strong> vermijden en bij <strong>storm</strong> je snelheid en stuurgedrag aanpassen.
    <br>Besturing: <strong>‚Üê/‚Üí</strong> sturen, <strong>‚Üë/‚Üì</strong> snelheid. <strong>Spatie</strong> = pauze.
  </p>

  <div class="wrap">
    <div class="stage">
      <canvas id="cv" width="900" height="520"></canvas>
    </div>

    <div class="panel">
      <div class="card">
        <div class="row"><span>Level</span><strong id="lvl">1 / 3</strong></div>
        <div class="row"><span>Status</span><strong id="status">Klaar</strong></div>
        <div class="row"><span>Poort</span><strong id="gate">0 / 0</strong></div>
        <div class="row"><span>Snelheid</span><strong id="spd">0.0</strong></div>
        <div class="row"><span>Koers</span><strong id="hdg">0¬∞</strong></div>
        <div class="row"><span>Weer</span><strong id="wx">Rustig</strong></div>
        <div class="row"><span>Radar</span><strong id="rad">‚Äî</strong></div>
      </div>

      <div class="msg" id="msg">
        Druk op <strong>Start</strong>. Vaar door poort 1 ‚Üí 2 ‚Üí ‚Ä¶ en daarna de haven in.
      </div>

      <div class="controls">
        <button class="primary" id="startBtn">Start</button>
        <button class="secondary" id="restartBtn">Opnieuw</button>
        <button class="secondary" id="pauseBtn">Pauze</button>
        <button class="danger" id="resetBtn">Reset</button>
        <button class="ghost" id="nextBtn" style="grid-column:1 / -1; display:none;">Volgende level</button>
      </div>

      <!-- Touch D-pad (alleen zichtbaar op mobiel door CSS) -->
      <div class="touchControls">
        <div class="card" style="padding:12px">
          <div class="row" style="margin-bottom:10px"><span>Mobiele besturing</span><strong>Touch</strong></div>
          <div class="dpad">
            <button class="ghost up"    data-key="up">‚Üë</button>
            <button class="ghost left"  data-key="left">‚Üê</button>
            <button class="ghost right" data-key="right">‚Üí</button>
            <button class="ghost down"  data-key="down">‚Üì</button>
          </div>
        </div>
      </div>

      <div class="card" style="color:#a9b7d3;font-size:13px;line-height:1.35">
        <strong style="color:#e7eefc">Storm-effecten</strong><br>
        Bij storm krijg je <strong>winddrift</strong>, <strong>golf-ruis</strong> (koers schommelt) en <strong>minder roer-grip</strong>.<br>
        Tip: <strong>verlaag snelheid</strong> en stuur <strong>eerder</strong>.
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d");

  const elLvl = document.getElementById("lvl");
  const elStatus = document.getElementById("status");
  const elGate = document.getElementById("gate");
  const elSpd = document.getElementById("spd");
  const elHdg = document.getElementById("hdg");
  const elWx = document.getElementById("wx");
  const elRad = document.getElementById("rad");
  const msg = document.getElementById("msg");

  const startBtn = document.getElementById("startBtn");
  const restartBtn = document.getElementById("restartBtn");
  const pauseBtn = document.getElementById("pauseBtn");
  const resetBtn = document.getElementById("resetBtn");
  const nextBtn = document.getElementById("nextBtn");

  const W = cv.width, H = cv.height;

  // ---------- Levels ----------
  const levels = [
    {
      name: "Level 1",
      harbour: { x: 830, y: 260, w: 55, h: 120 },
      gates: [
        { a:{x:240,y:170}, b:{x:260,y:260} },
        { a:{x:420,y:320}, b:{x:440,y:230} },
        { a:{x:610,y:180}, b:{x:630,y:280} },
        { a:{x:730,y:320}, b:{x:750,y:230} },
      ],
      sandbanks: [
        {x:340,y:130,r:52},
        {x:520,y:380,r:62},
        {x:610,y:250,r:48},
        {x:710,y:140,r:40},
      ],
      gateTolerance: 22,
      stormSeverity: 1.0,
      stormSpeedLimit: 3.2,
      weatherProfile: { calm:0.10, wind:0.25, storm:0.65 }
    },
    {
      name: "Level 2",
      harbour: { x: 830, y: 260, w: 55, h: 120 },
      gates: [
        { a:{x:210,y:310}, b:{x:235,y:210} },
        { a:{x:330,y:170}, b:{x:360,y:270} },
        { a:{x:470,y:330}, b:{x:500,y:235} },
        { a:{x:600,y:180}, b:{x:630,y:280} },
        { a:{x:700,y:350}, b:{x:730,y:250} },
        { a:{x:770,y:210}, b:{x:795,y:310} },
      ],
      sandbanks: [
        {x:280,y:140,r:45},
        {x:380,y:395,r:60},
        {x:520,y:130,r:45},
        {x:560,y:320,r:62},
        {x:680,y:220,r:48},
        {x:760,y:140,r:38},
      ],
      gateTolerance: 20,
      stormSeverity: 1.25,
      stormSpeedLimit: 3.0,
      weatherProfile: { calm:0.32, wind:0.38, storm:0.30 }
    },
    {
      name: "Level 3",
      harbour: { x: 830, y: 260, w: 55, h: 120 },
      gates: [
        { a:{x:190,y:190}, b:{x:215,y:310} },
        { a:{x:280,y:340}, b:{x:305,y:230} },
        { a:{x:380,y:170}, b:{x:405,y:280} },
        { a:{x:480,y:350}, b:{x:505,y:245} },
        { a:{x:590,y:185}, b:{x:615,y:285} },
        { a:{x:690,y:360}, b:{x:715,y:250} },
        { a:{x:760,y:200}, b:{x:785,y:315} },
      ],
      sandbanks: [
        {x:250,y:150,r:48},
        {x:310,y:420,r:58},
        {x:420,y:120,r:44},
        {x:470,y:300,r:58},
        {x:560,y:410,r:60},
        {x:620,y:160,r:45},
        {x:720,y:120,r:42},
        {x:720,y:320,r:52},
      ],
      gateTolerance: 18,
      stormSeverity: 1.45,
      stormSpeedLimit: 2.8,
      weatherProfile: { calm:0.22, wind:0.36, storm:0.42 }
    }
  ];

  let levelIndex = 0;
  let L = levels[levelIndex];

  // ---------- Game state ----------
  const ship = {
    x: 90,
    y: 260,
    heading: 0,
    speed: 0,
    maxSpeed: 4.6,
    turnRate: 0.055
  };

  let running = false;
  let paused = false;
  let gateIndex = 0;
  let lastTs = 0;

  let weather = {
    level: 0.0,
    target: 0.0,
    t: 0.0,
    wavePhase: 0.0
  };

  // Input
  const keys = { left:false, right:false, up:false, down:false };

  // ---------- UI ----------
  function setUI(){
    elLvl.textContent = `${levelIndex+1} / ${levels.length}`;
    elGate.textContent = `${gateIndex} / ${L.gates.length}`;
    elSpd.textContent = ship.speed.toFixed(1);

    let deg = (ship.heading * 180 / Math.PI) % 360;
    if (deg < 0) deg += 360;
    elHdg.textContent = `${Math.round(deg)}¬∞`;

    const w = weather.level;
    if (w < 0.25) elWx.textContent = "Rustig";
    else if (w < 0.6) elWx.textContent = "Wind";
    else elWx.textContent = "Storm";

    elStatus.textContent = paused ? "Pauze" : (running ? "Varend" : "Klaar");
  }

  function setMessage(html){
    msg.innerHTML = html;
  }

  function loadLevel(i){
    levelIndex = i;
    L = levels[levelIndex];

    ship.x = 90;
    ship.y = 260;
    ship.heading = 0;
    ship.speed = 0;

    gateIndex = 0;
    running = false;
    paused = false;
    lastTs = 0;

    weather.level = 0;
    weather.target = 0.05;
    weather.t = 0;
    weather.wavePhase = 0;

    elRad.textContent = "‚Äî";
    nextBtn.style.display = "none";
    setMessage(`Druk op <strong>Start</strong>. Volg poort 1 ‚Üí ${L.gates.length} en vaar daarna de haven in.`);
    setUI();
    draw();
  }

  // ---------- Geometry ----------
  function dist(ax,ay,bx,by){ return Math.hypot(ax-bx, ay-by); }

  function pointLineDistance(px,py, ax,ay, bx,by){
    const vx = bx-ax, vy = by-ay;
    const wx = px-ax, wy = py-ay;
    const c1 = vx*wx + vy*wy;
    if (c1 <= 0) return dist(px,py,ax,ay);
    const c2 = vx*vx + vy*vy;
    if (c2 <= c1) return dist(px,py,bx,by);
    const t = c1 / c2;
    return dist(px,py, ax + t*vx, ay + t*vy);
  }

  function shallowAt(x,y){
    let risk = 0;
    for (const s of L.sandbanks){
      const d = dist(x,y,s.x,s.y);
      const r = s.r;
      if (d < r) risk = Math.max(risk, 1.0);
      else {
        const halo = r * 1.4;
        if (d < halo){
          const t = 1 - (d - r) / (halo - r);
          risk = Math.max(risk, 0.55 * t);
        }
      }
    }
    const edge = Math.min(x, W-x, y, H-y);
    if (edge < 60){
      risk = Math.max(risk, 0.3 * (1 - edge/60));
    }
    return Math.min(1, risk);
  }

  function radarUpdate(){
    let nearest = Infinity;
    for (const s of L.sandbanks){
      const d = dist(ship.x, ship.y, s.x, s.y) - s.r;
      nearest = Math.min(nearest, d);
    }
    const shallow = shallowAt(ship.x, ship.y);

    if (shallow >= 0.95){
      elRad.textContent = "‚ùó ONDIEPTE";
    } else if (nearest < 55 || shallow > 0.5){
      elRad.textContent = "‚ö† dicht bij ondiepte";
    } else {
      elRad.textContent = "‚úì vrij water";
    }
  }

  function passedGate(i){
    const g = L.gates[i];
    const ax=g.a.x, ay=g.a.y, bx=g.b.x, by=g.b.y;
    const d = pointLineDistance(ship.x, ship.y, ax,ay,bx,by);
    if (d > L.gateTolerance) return false;

    const minX = Math.min(ax,bx)-30, maxX = Math.max(ax,bx)+30;
    const minY = Math.min(ay,by)-30, maxY = Math.max(ay,by)+30;
    if (ship.x < minX || ship.x > maxX || ship.y < minY || ship.y > maxY) return false;

    return true;
  }

  function reachedHarbour(){
    const h = L.harbour;
    return ship.x >= h.x &&
      ship.y >= h.y - h.h/2 &&
      ship.y <= h.y + h.h/2;
  }

  // ---------- Weather ----------
  function pickWeatherTarget(){
    const r = Math.random();
    const p = L.weatherProfile;
    if (r < p.calm) return 0.05;
    if (r < p.calm + p.wind) return 0.45;
    return 0.9;
  }

  function updateWeather(dt){
    weather.t += dt;
    weather.wavePhase += dt * (1.4 + 2.0*weather.level);

    if (weather.t > 3 + Math.random()*1.5){
      weather.t = 0;
      weather.target = pickWeatherTarget();

      if (weather.target > 0.7){
        setMessage("‚ö† Weerstation: storm op komst. Verlaag snelheid en stuur eerder.");
      } else if (weather.target > 0.25){
        setMessage("üå¨ Weerstation: wind neemt toe. Houd radar in de gaten.");
      } else {
        setMessage("‚òÄ Weerstation: weer stabiel.");
      }
    }

    const k = 0.6;
    weather.level += (weather.target - weather.level) * (1 - Math.exp(-k*dt));
  }

  // ---------- Fail/Win ----------
  function fail(text){
    running = false;
    paused = false;
    ship.speed = 0;
    setMessage(text);
    setUI();
    draw();
  }

  function win(){
    running = false;
    paused = false;
    ship.speed = 0;

    if (levelIndex < levels.length - 1){
      nextBtn.style.display = "block";
      setMessage(`‚úÖ Geslaagd! Je hebt ${L.gates.length} poorten gehaald en vaart veilig de haven binnen.<br><strong>Volgende level?</strong>`);
    } else {
      nextBtn.style.display = "none";
      setMessage("üèÅ Klaar! Je hebt alle levels gehaald. Dat is serieus kapiteinswerk.");
    }
    setUI();
    draw();
  }

  function damageCheck(){
    const shallow = shallowAt(ship.x, ship.y);

    if (shallow >= 0.95){
      fail("üí• Je liep vast op een ondiepte. Pas je koers aan en probeer opnieuw.");
      return true;
    }

    if (weather.level > 0.6 && ship.speed > L.stormSpeedLimit){
      fail(`üå© Te hard gevaren tijdens storm. Schip beschadigd. Houd snelheid ‚â§ ${L.stormSpeedLimit.toFixed(1)} bij storm.`);
      return true;
    }

    return false;
  }

  // ---------- Core update ----------
  function update(dt){
    if (!running || paused) return;

    updateWeather(dt);

    if (keys.up) ship.speed = Math.min(ship.maxSpeed, ship.speed + 2.1*dt);
    if (keys.down) ship.speed = Math.max(0, ship.speed - 3.0*dt);

    const storm = weather.level;
    const sev = L.stormSeverity;

    const drift = (10 + 35*storm) * sev;
    const windX = 0.75 * drift;
    const windY = -0.35 * drift;

    const wave = Math.sin(weather.wavePhase * 2.2) * (0.010 + 0.020*storm) * (0.6 + 0.6*(ship.speed/ship.maxSpeed)) * sev;
    ship.heading += wave;

    const grip = Math.max(0.45, 1.0 - 0.55*storm - 0.15*(ship.speed/ship.maxSpeed));
    const turn = ship.turnRate * grip;

    if (keys.left) ship.heading -= turn;
    if (keys.right) ship.heading += turn;

    ship.x += Math.cos(ship.heading) * ship.speed * 60 * dt + windX * dt;
    ship.y += Math.sin(ship.heading) * ship.speed * 60 * dt + windY * dt;

    ship.x = Math.max(20, Math.min(W-20, ship.x));
    ship.y = Math.max(20, Math.min(H-20, ship.y));

    if (gateIndex < L.gates.length){
      if (passedGate(gateIndex)){
        gateIndex++;
        if (gateIndex < L.gates.length){
          setMessage(`‚úÖ Poort ${gateIndex} gehaald. Op naar poort ${gateIndex+1}.`);
        } else {
          setMessage("‚úÖ Alle poorten gehaald. Vaar nu de haven in.");
        }
      }
    }

    radarUpdate();

    if (damageCheck()) return;

    if (reachedHarbour()){
      if (gateIndex < L.gates.length){
        fail("‚ùå Je ging de haven in zonder alle poorten te halen. Volg eerst de vaargeul (alle poorten).");
        return;
      }
      win();
      return;
    }

    if (ship.x > W-55 && gateIndex < L.gates.length){
      fail("‚ùå Je bent uit de vaargeul geraakt. Probeer de poorten te volgen (in volgorde).");
      return;
    }

    setUI();
    draw();
    requestAnimationFrame(loop);
  }

  function loop(ts){
    if (!running) return;
    if (!lastTs) lastTs = ts;
    const dt = Math.min(0.033, (ts - lastTs) / 1000);
    lastTs = ts;
    update(dt);
  }

  // ---------- Drawing ----------
  function drawSea(){
    ctx.fillStyle = "#0e1b33";
    ctx.fillRect(0,0,W,H);

    const cell = 24;
    for (let y=0; y<H; y+=cell){
      for (let x=0; x<W; x+=cell){
        const r = shallowAt(x+cell/2, y+cell/2);
        if (r < 0.08) continue;
        const a = 0.18 * r;
        ctx.fillStyle = `rgba(226,232,240,${a})`;
        ctx.fillRect(x,y,cell,cell);
      }
    }

    if (weather.level > 0.35){
      const a = 0.10 + 0.14*(weather.level-0.35)/0.65;
      ctx.fillStyle = `rgba(148,163,184,${a})`;
      for (let i=0;i<36;i++){
        ctx.fillRect(0, i*16, W, 4);
      }
      ctx.strokeStyle = `rgba(226,232,240,${0.06 + 0.18*weather.level})`;
      for (let i=0;i<70 + Math.floor(70*weather.level); i++){
        const rx = (Math.random()*W)|0;
        const ry = (Math.random()*H)|0;
        ctx.beginPath();
        ctx.moveTo(rx, ry);
        ctx.lineTo(rx+10, ry+18);
        ctx.stroke();
      }
    }

    for (const s of L.sandbanks){
      ctx.fillStyle = "rgba(194,178,128,.95)";
      ctx.beginPath();
      ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "rgba(15,23,42,.12)";
      ctx.beginPath();
      ctx.arc(s.x-8,s.y-8,s.r*0.55,0,Math.PI*2);
      ctx.fill();
    }
  }

  function drawBuoy(x,y,color,glow){
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(x,y,11,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle = "rgba(226,232,240,.55)";
    ctx.beginPath();
    ctx.arc(x,y-6,3,0,Math.PI*2);
    ctx.fill();

    if (glow){
      ctx.fillStyle = (color==="#ef4444") ? "rgba(239,68,68,.18)" : "rgba(34,197,94,.18)";
      ctx.beginPath();
      ctx.arc(x,y,26,0,Math.PI*2);
      ctx.fill();
    }
  }

  function drawGates(){
    for (let i=0;i<L.gates.length;i++){
      const g = L.gates[i];
      const isNext = (i === gateIndex);

      ctx.strokeStyle = isNext ? "rgba(96,165,250,.65)" : "rgba(255,255,255,.10)";
      ctx.lineWidth = isNext ? 3 : 1;
      ctx.beginPath();
      ctx.moveTo(g.a.x, g.a.y);
      ctx.lineTo(g.b.x, g.b.y);
      ctx.stroke();
      ctx.lineWidth = 1;

      drawBuoy(g.a.x, g.a.y, "#ef4444", isNext);
      drawBuoy(g.b.x, g.b.y, "#22c55e", isNext);
    }
  }

  function drawHarbour(){
    const h = L.harbour;
    ctx.fillStyle = "rgba(148,163,184,.95)";
    ctx.fillRect(h.x, h.y-h.h/2, h.w, h.h);
    ctx.fillStyle = "#020617";
    ctx.font = "bold 13px system-ui";
    ctx.fillText("HAVEN", h.x+6, h.y-h.h/2-10);
  }

  function drawShip(){
    ctx.save();
    ctx.translate(ship.x, ship.y);
    ctx.rotate(ship.heading);

    ctx.fillStyle = "rgba(191,219,254,.14)";
    ctx.beginPath();
    ctx.ellipse(-28, 0, 22, 10, 0, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = "rgba(96,165,250,.95)";
    ctx.beginPath();
    ctx.moveTo(26,0);
    ctx.lineTo(-18,-12);
    ctx.lineTo(-28,0);
    ctx.lineTo(-18,12);
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = "rgba(226,232,240,.85)";
    ctx.fillRect(-10,-6,14,12);

    ctx.strokeStyle = "rgba(15,23,42,.35)";
    ctx.beginPath();
    ctx.moveTo(26,0);
    ctx.lineTo(-18,-12);
    ctx.lineTo(-28,0);
    ctx.lineTo(-18,12);
    ctx.closePath();
    ctx.stroke();

    ctx.restore();
  }

  function drawHUD(){
    const x = 16, y = 16;
    ctx.fillStyle = "rgba(0,0,0,.25)";
    ctx.fillRect(x,y,220,74);

    ctx.fillStyle = "rgba(226,232,240,.85)";
    ctx.font = "12px system-ui";
    ctx.fillText(`LEVEL ${levelIndex+1}`, x+10, y+18);

    const shallow = shallowAt(ship.x, ship.y);
    const warn = shallow > 0.5;

    ctx.fillStyle = warn ? "rgba(245,158,11,.95)" : "rgba(34,197,94,.95)";
    ctx.fillText(warn ? "ONDIEPTE WAARSCHUWING" : "Vrij water", x+10, y+38);

    ctx.fillStyle = weather.level > 0.6 ? "rgba(239,68,68,.95)" :
                    (weather.level > 0.25 ? "rgba(245,158,11,.95)" : "rgba(34,197,94,.95)");
    ctx.fillText(weather.level > 0.6 ? "STORM (minder grip + drift)" :
                (weather.level > 0.25 ? "WIND (drift)" : "RUSTIG"), x+10, y+58);
  }

  function draw(){
    drawSea();
    drawGates();
    drawHarbour();
    drawShip();
    drawHUD();
  }

  // ---------- Controls ----------
  function togglePause(){
    if (!running) return;
    paused = !paused;
    setUI();
    setMessage(paused ? "‚è∏ Gepauzeerd." : "‚ñ∂ Verder varen‚Ä¶");
    if (!paused){
      lastTs = 0;
      requestAnimationFrame(loop);
    }
  }

  // Keyboard
  window.addEventListener("keydown", (e) => {
    if (e.key === "ArrowLeft") { keys.left = true; e.preventDefault(); }
    if (e.key === "ArrowRight"){ keys.right = true; e.preventDefault(); }
    if (e.key === "ArrowUp")   { keys.up = true; e.preventDefault(); }
    if (e.key === "ArrowDown") { keys.down = true; e.preventDefault(); }
    if (e.code === "Space") { togglePause(); e.preventDefault(); }
  });

  window.addEventListener("keyup", (e) => {
    if (e.key === "ArrowLeft") keys.left = false;
    if (e.key === "ArrowRight") keys.right = false;
    if (e.key === "ArrowUp") keys.up = false;
    if (e.key === "ArrowDown") keys.down = false;
  });

  // Touch D-pad (mobile)
  function setKey(name, isDown){ keys[name] = isDown; }

  document.querySelectorAll("[data-key]").forEach(btn => {
    const k = btn.dataset.key;

    const down = (e) => { e.preventDefault(); setKey(k, true); };
    const up   = (e) => { e.preventDefault(); setKey(k, false); };

    btn.addEventListener("pointerdown", down, {passive:false});
    btn.addEventListener("pointerup", up, {passive:false});
    btn.addEventListener("pointercancel", up, {passive:false});
    btn.addEventListener("pointerleave", up, {passive:false});
  });

  window.addEventListener("blur", () => {
    keys.left = keys.right = keys.up = keys.down = false;
  });

  startBtn.addEventListener("click", () => {
    if (running) return;
    running = true;
    paused = false;
    ship.speed = 1.6;
    setMessage(`üö¢ Je vaart. Volg poort 1 ‚Üí ${L.gates.length}. Let op: bij storm is sturen lastiger.`);
    setUI();
    lastTs = 0;
    requestAnimationFrame(loop);
  });

  restartBtn.addEventListener("click", () => {
    loadLevel(levelIndex);
    running = true;
    ship.speed = 1.6;
    setMessage("üö¢ Opnieuw gestart. Volg poorten in volgorde.");
    setUI();
    lastTs = 0;
    requestAnimationFrame(loop);
  });

  pauseBtn.addEventListener("click", togglePause);

  resetBtn.addEventListener("click", () => {
    loadLevel(levelIndex);
  });

  nextBtn.addEventListener("click", () => {
    if (levelIndex < levels.length - 1){
      loadLevel(levelIndex + 1);
    }
  });

  // ---------- Init ----------
  loadLevel(0);
})();
</script>
</body>
</html>
